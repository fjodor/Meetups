---
title: 'Datenanalyse / Statistik mit R leicht gemacht!'
subtitle: "Data Science Meetup Darmstadt"
author: "Wolf Riepl"
date: 'Bericht erstellt: `r Sys.time()`'
# output: html_document   # Zur Erweiterung "html_document" hier löschen und in neuer Zeile verwenden wie unten
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
    code_download: yes
---

```{r setup, include = FALSE}

library(tidyverse)
library(DT)
library(plotly)
library(report)

library(gt)
library(gtsummary)

library(chartmusicdata)
data(topsongs)
data(topalbums)

# Spalte "raw_row" entfernen für übersichtlichere Darstellungen

topalbums <- topalbums %>% 
  select(-raw_row)

knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_chunk$set(comment = NA)

```

# Datenbasis

## Beschreibung im Fließtext

*Hier werden R-Ausdrücke direkt in den Text eingebettet. Anwendungsbeispiel: Kontinuierliche Datenerhebung mit sich ändernden Fallzahlen. Die Zahlen im Text werden bei der Berichtserstellung automatisch aktualisiert.*

Die folgenden Daten beruhen auf `r nrow(topalbums)` Alben von `r length(unique(topalbums$artist))` verschiedenen Bands / Künstlern. Sie stammen von der Webseite https://tsort.info/. Wir verwenden die Version **`r attr(topalbums, "version")`**.


## Interaktive Daten-Tabelle

```{r Daten-Tabelle}
DT::datatable(topalbums)

# Zum Ausprobieren: Argument filter; z. B. "filter = "top" oder filter = "bottom"
# DT::datatable(topalbums, filter = "xxx")

# Zum Ausprobieren: Argument options = list(pageLength = x)
# DT::datatable(topalbums, options = list(pageLength = 7))

```


# Gruppenvergleiche

## t-Test: Standard-Ausgabe

Rs Standard-Ausgabe ist nicht direkt für Publikationen verwendbar ...

```{r}

my_bands <- topalbums %>% 
  filter(artist %in% c("Bob Dylan", "The Beatles"))

my_test <- t.test(final_score ~ artist,
   alternative = 'two.sided',
   conf.level = .95, var.equal = FALSE,
   data = my_bands)

my_test

```

### t-Test: Text-Interpretation mit *report*

Ergebnisse wie oben textlich fundiert und publikationsfähig zu interpretieren, ist nicht für jedeN der schönste Teil der Datenanalyse. Praktisch, wenn es einfach geht:

```{r, warning = FALSE}
# R-Paket: report

report(my_test)

```


### t-Test: Grafische Darstellung mit *ggstatsplot*

```{r}
# R-Paket: ggstatsplot

ggbetweenstats(my_bands,
  x = artist, y = final_score,
  title = "Gesamtpunkte im Vergleich",
  caption = "Datenquelle: tsort.info")
```


## Gruppenvergleich: Tabellarisch mit *gtsummary*

*add_p()* wählt automatisch einen Test aus; hier: Wilcoxon Rank-Sum Test.

```{r}

my_bands %>% 
  tbl_summary(by = artist) %>% 
  add_p()


# Alternative: Hier direkt die Bands ändern

topalbums %>%
  select(final_score, artist) %>%
  filter(artist %in% c("Madonna", "Bruce Springsteen")) %>%
  tbl_summary(by = artist) %>%
  add_p()

```

Stattdessen t-Test vorgeben, siehe *?add_p()*:

```{r}

topalbums %>% 
  select(year, ueber5) %>% 
  tbl_summary(by = ueber5) %>% 
  add_p(
    # perform t-test for all variables
    test = everything() ~ "t.test",
    # assume equal variance in the t-test
    test.args = all_tests("t.test") ~ list(var.equal = TRUE)
)

```


## Gruppenvergleich: Vorschläge für andere Tests

Für Fortgeschrittene zum Üben: Andere Fragestellungen testen.

Vorschlag: Unterscheiden sich Alben, die über 5 Punkte erreicht haben, von Alben, die max. 5 Punkte erreicht haben, im durchschnittlichen Alter?
Vermutung / Hypothese: Erfolgreichere Alben sind durchschnittlich älter.

Alternative Idee: Unterscheiden sich Alben, die bis zu dem einschneidenden Jahr 1990 veröffentlicht wurden, in der durchschnittlichen Gesamtpunktzahl von Alben, die nach 1990 veröffentlicht wurden?

Oder andere Bands auswählen.

Oder mit anderen Daten arbeiten: ***topsongs*** bzw. für aktuellere Musik ***albums2000, songs2000***.

Wer mag, kann, analog zu oben, Test-Einstellungen variieren (t-Test, gleiche Varianzen annehmen ja oder nein).

```{r}

# Unterscheiden sich Alben, die über 5 Punkte erreicht haben, von Alben, die max. 5 Punkte erreicht haben, im durchschnittlichen Alter?
# Vermutung / Hypothese: Erfolgreichere Alben sind durchschnittlich älter.

topalbums <- topalbums %>% 
  mutate(ueber5 = ifelse(final_score > 5, "> 5 P", "< 5 P"))

# Variable in erster Zeile einfügen
# my_test <- t.test(year ~ xxx,
#    alternative = 'greater',
#    conf.level = .95, var.equal = FALSE,
#    data = topalbums)
# 
# my_test

# Text-Interpretation: report


# Grafisch: ggstatsplot


# Tabellarisch: gtsummary


```



# Korrelation

## Standard-Ausgabe


## Text-Interpretation

## Grafisch


# Regression

## Standard-Ausgabe

## Text-Interpretation


# Ergänzungen

## Interaktive Grafiken


## Animationen


# Ergänzungen - überarbeiten und entfernen!

# Interaktive Grafiken

## Streudiagramm

```{r Interaktiv}

# Dynamisch: Mouse-Over. Nur in HTML! Benötigt Javascript.
# Zuerst ggplot2 ...

Top6_plot <- ggplot(Top6, aes(x = year, y = final_score, label = name, col = artist)) +
  labs(title = "Alben & Punktzahlen",
       subtitle = "Top 6 Bands mit den höchsten Gesamtpunkten",
       x = "Jahr", y = "Punktzahl") +
  scale_color_discrete(name = "Künstler / Band") +
  geom_point()

# ... dann plotly
ggplotly(Top6_plot)

```

## Diamonds

```{r diamonds, message = FALSE}
library(plotly)
p <- ggplot(data = diamonds, aes(x = cut, fill = clarity)) +
            geom_bar(position = "dodge")
ggplotly(p)
```


## texreg::htmlreg

Ein Modell:

```{r Regression_Stones_texreg, results = 'asis'}
htmlreg(Stones_lm, doctype = FALSE)
htmlreg(Stones_lm, single.row = TRUE, doctype = FALSE)
```

Vergleich von zwei Modellen:

```{r Regression_comparison_texreg, results = 'asis'}
Beatles <- Top6 %>%
  filter(artist == "The Beatles")
Beatles_lm <- lm(raw_eur ~ raw_usa, data = Beatles)

htmlreg(list(Stones_lm, Beatles_lm),
        custom.model.names = c("Stones", "Beatles"),
        doctype = FALSE)
```


# Statistische Ergebnisse berichten: gt und gtsummary

## gt

Das **gt-Paket** ermöglicht sehr flexibel gestaltbare Tabellen, z. B. so:

```{r gt1}

Top6 %>% 
  head() %>% 
  gt()

```

Nehmen wir an, final_score wäre in US-Dollar - wie können wir die Zahlen einfach formatieren?

Dazu Tabellenüberschrift und Unter-Überschrift; Zellen mit raw_usa > 24 hervorgehoben.

```{r gt2}

Top6 %>%
  head() %>% 
  gt() %>% 
  fmt_currency(columns = "final_score",
               currency = "USD") %>% 
  tab_header(title = "Top Alben",
             subtitle = glue::glue("Von {min(Top6$year)} bis {max(Top6$year)}")) %>% 
  tab_style(
    style = list(
      cell_fill(color = "lightblue"),
      cell_text(style = "italic")
    ),
    locations = cells_body(
      columns = raw_usa,
      rows = raw_usa > 24
    )
  )

```
